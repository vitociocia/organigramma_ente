{% extends "base.html" %}

{% block container %}
<div class="container my-4">
  <div class="col-lg-10 mx-auto">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        {% if form.instance.pk %}Modifica Responsabile{% else %}Crea Nuovo Responsabile{% endif %}
      </h2>
      <a href="{% url 'responsabile_list' %}" class="btn btn-outline-secondary">Torna alla lista</a>
    </div>

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <form method="post">
      {% csrf_token %}

      <div class="row g-3">
        <!-- Colonna sinistra -->
        <div class="col-lg-8">
          <div class="card shadow-sm mb-3">
            <div class="card-header"><strong>Dati anagrafici</strong></div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="{{ form.nome.id_for_label }}">Nome</label>
                  {{ form.nome }}
                  {% if form.nome.errors %}<div class="text-danger small">{{ form.nome.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="{{ form.cognome.id_for_label }}">Cognome</label>
                  {{ form.cognome }}
                  {% if form.cognome.errors %}<div class="text-danger small">{{ form.cognome.errors }}</div>{% endif %}
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="{{ form.codice_fiscale.id_for_label }}">Codice fiscale</label>
                  {{ form.codice_fiscale }}
                  {% if form.codice_fiscale.errors %}<div class="text-danger small">{{ form.codice_fiscale.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label" for="{{ form.email.id_for_label }}">Email</label>
                  {{ form.email }}
                  {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-header"><strong>Qualifica & Stato</strong></div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8 mb-3">
                  <label class="form-label" for="{{ form.qualifica.id_for_label }}">Qualifica</label>
                  {{ form.qualifica }}
                  {% if form.qualifica.errors %}<div class="text-danger small">{{ form.qualifica.errors }}</div>{% endif %}
                </div>
                <div class="col-md-4 mb-3 d-flex align-items-center">
                  <div class="form-check">
                    {{ form.in_carica }}
                    <label class="form-check-label" for="{{ form.in_carica.id_for_label }}">In carica</label>
                  </div>
                </div>
              </div>
              <div class="small text-muted">
                Se il responsabile non è più in servizio, imposta <em>Data fine</em> nella card a destra e (facoltativamente) deseleziona <em>In carica</em>.
              </div>
            </div>
          </div>
        </div>

        <!-- Colonna destra -->
        <div class="col-lg-4">
          <!-- Card Periodo di attività: colore dinamico -->
          <div id="period-card" class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Periodo di attività</strong>
              <span id="status-badge" class="badge bg-secondary">—</span>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label" for="{{ form.data_inizio.id_for_label }}">Data inizio</label>
                {{ form.data_inizio }}
                <div class="form-text">{{ form.fields.data_inizio.help_text }}</div>
                {% if form.data_inizio.errors %}<div class="text-danger small">{{ form.data_inizio.errors }}</div>{% endif %}
              </div>
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0" for="{{ form.data_fine.id_for_label }}">Data fine</label>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-clear-fine">Pulisci</button>
                    <button class="btn btn-sm btn-outline-danger" type="button" id="btn-close-today">Oggi</button>
                  </div>
                </div>
                {{ form.data_fine }}
                <div class="form-text">{{ form.fields.data_fine.help_text }}</div>
                {% if form.data_fine.errors %}<div class="text-danger small">{{ form.data_fine.errors }}</div>{% endif %}
              </div>
              <div class="small">
                <ul class="mb-0 ps-3">
                  <li><strong>Verde</strong>: “in carica” <em>oppure</em> periodo ancora attivo (Data fine <em>strettamente</em> nel futuro).</li>
                  <li><strong>Grigio</strong>: Data fine <span class="text-nowrap">≤ oggi</span> oppure non in carica.</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">Salva</button>
            <a href="{% url 'responsabile_list' %}" class="btn btn-secondary">Annulla</a>
          </div>
        </div>
      </div>
    </form>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const inCarica = document.getElementById('{{ form.in_carica.id_for_label }}') || document.getElementById('id_in_carica');
  const inizio   = document.getElementById('{{ form.data_inizio.id_for_label }}') || document.getElementById('id_data_inizio');
  const fine     = document.getElementById('{{ form.data_fine.id_for_label }}')   || document.getElementById('id_data_fine');

  const btnToday = document.getElementById('btn-close-today');
  const btnClear = document.getElementById('btn-clear-fine');

  const periodCard  = document.getElementById('period-card');
  const statusBadge = document.getElementById('status-badge');

  function todayISO() {
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
  }

  function parseISO(value) {
    if (!value) return null;
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }

  // Attivo se: (inizio assente o <= oggi) E (fine assente o > oggi).
  function isActiveByDates(diStr, dfStr, todayStr) {
    const di = parseISO(diStr);
    const df = parseISO(dfStr);
    const t  = parseISO(todayStr);
    if (!t) return true;

    const startOk = (!di) || (di <= t);
    const endOk   = (!df) || (df > t);   // <— qui la modifica: fine == oggi => NON attivo
    return startOk && endOk;
  }

  function updatePeriodCard() {
    const activeDates = isActiveByDates(inizio?.value, fine?.value, todayISO());
    const inCharge    = !!(inCarica && inCarica.checked);

    // Se la fine è impostata e <= oggi, forziamo “non attivo” a prescindere da in_carica
    let isActive = activeDates || inCharge;
    const df = parseISO(fine?.value);
    const today = parseISO(todayISO());
    if (df && today && df <= today) {
      isActive = false;
    }

    periodCard.classList.remove('border-success', 'bg-success-subtle', 'border-secondary', 'bg-light');
    statusBadge.classList.remove('bg-success', 'bg-secondary');

    if (isActive) {
      periodCard.classList.add('border-success', 'bg-success-subtle');
      statusBadge.classList.add('bg-success');
      statusBadge.textContent = 'Attivo';
    } else {
      periodCard.classList.add('border-secondary', 'bg-light');
      statusBadge.classList.add('bg-secondary');
      statusBadge.textContent = 'Non attivo';
    }
  }

  // Pulsanti rapidi
  if (btnToday && fine) {
    btnToday.addEventListener('click', function() {
      fine.value = todayISO();
      if (inCarica) inCarica.checked = false;
      updatePeriodCard();
    });
  }
  if (btnClear && fine) {
    btnClear.addEventListener('click', function() {
      fine.value = "";
      if (inCarica) inCarica.checked = true;
      updatePeriodCard();
    });
  }

  // Reattività ai cambi manuali
  if (fine) {
    fine.addEventListener('change', function () {
      const df = parseISO(fine.value);
      const t  = parseISO(todayISO());
      if (df && t && df <= t && inCarica) {
        inCarica.checked = false; // se fine è oggi o passata, togli "in carica"
      }
      updatePeriodCard();
    });
  }
  if (inCarica) inCarica.addEventListener('change', updatePeriodCard);
  if (inizio)   inizio.addEventListener('change', updatePeriodCard);

  // Prima verniciata
  updatePeriodCard();
});
</script>
{% endblock %}
